# Azure OpenAI Metrics Collection Script

A comprehensive PowerShell script for collecting and analyzing Azure OpenAI service metrics across multiple resources in your Azure subscription.

## üéØ Purpose

This script automatically discovers all Azure OpenAI resources in your subscription and collects detailed usage metrics, providing both console output and CSV export for analysis. It's designed for organizations managing multiple Azure OpenAI resources who need consolidated reporting.

## ‚ú® Features

- **Automatic Resource Discovery**: Finds all Azure OpenAI resources in your subscription
- **Comprehensive Metrics Collection**: Gathers 6 key metrics for each resource
- **Flexible Time Range**: Configurable lookback period (default: 7 days)
- **Summary Statistics**: Provides overall consumption and success rate analysis
- **Real Cost Analysis**: Integrates with Azure Cost Management for actual billing costs
- **High Performance**: Parallel processing for fast metrics collection across multiple resources
- **CSV Export**: Exports detailed data with timestamps for further analysis
- **Error Handling**: Gracefully handles resources with no data or access issues
- **Visual Output**: Color-coded console output with clear formatting

## üìä Collected Metrics

| Metric | Description |
|--------|-------------|
| **TotalTokens** | Combined input and output tokens consumed |
| **InputTokens** | Tokens sent to the model (prompts, context) |
| **OutputTokens** | Tokens generated by the model (responses) |
| **TotalRequests** | Total number of API requests made |
| **SuccessfulCalls** | Number of successful API calls |
| **TotalErrors** | Number of failed requests |
| **SuccessRate** | Calculated percentage of successful calls |
| **ActualCostUSD** | Real billing costs from Azure Cost Management API |

## üîß Prerequisites

### Required Software
- **PowerShell 5.1** or later
- **Azure CLI** (version 2.0 or later)

### Azure Requirements
- Valid Azure subscription with Azure OpenAI resources
- Azure CLI logged in (`az login`)
- Permissions to:
  - Read Azure resources in the subscription
  - Access Azure Monitor metrics
  - Query Azure Resource Graph
  - **Access Azure Cost Management** (for cost data collection)

## üì• Installation

1. **Install Azure CLI** (if not already installed):
   ```powershell
   # Using winget (recommended)
   winget install Microsoft.AzureCLI
   
   # Or download from: https://aka.ms/installazurecliwindows
   ```

2. **Login to Azure**:
   ```powershell
   az login
   ```

3. **Download the Script**:
   Save `collect-openai-metrics.ps1` to your desired directory.

## üöÄ Usage

### Basic Usage
```powershell
# Run with default settings (7 days, default subscription)
.\collect-openai-metrics.ps1

# Specify subscription ID
.\collect-openai-metrics.ps1 -SubscriptionId "your-subscription-id"

# Collect last 30 days of data
.\collect-openai-metrics.ps1 -DaysBack 30

# Full customization
.\collect-openai-metrics.ps1 -SubscriptionId "your-subscription-id" -DaysBack 14
```

### Parameters

| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `SubscriptionId` | String | `"8cebb108-a4d5-402b-a0c4-f7556126277f"` | Azure subscription ID to scan |
| `DaysBack` | Integer | `7` | Number of days to look back for metrics |

## üìà Sample Output

### Console Output
```
üîç Azure OpenAI Metrics Collection Report
=========================================
Setting subscription context...
Discovering OpenAI resources...
Found 7 OpenAI resources
Collecting metrics from 2025-10-07T10:30:00Z to 2025-10-14T10:30:00Z
Collecting cost data from 2025-10-07 to 2025-10-14

Processing resources in parallel...
  Processing: azure-openai-eastus-prod
  Processing: azure-openai-westus-dev
  Processing: azure-openai-southcentral-test

üìä Azure OpenAI Metrics Summary (Last 7 days)
======================================================

ResourceName               ResourceGroup      Location       TotalTokens InputTokens OutputTokens TotalRequests SuccessfulCalls TotalErrors SuccessRate ActualCostUSD
------------               -------------      --------       ----------- ----------- ------------ ------------- --------------- ----------- ----------- -------------
azure-openai-eastus-prod  rg-openai-prod    East US        4713        3025        1688         7             4               3           57.1        2.85
azure-openai-westus-dev   rg-openai-dev     West US        0           0           0            0             0               0           0           0.00
azure-openai-sc-test      rg-openai-test    South Central  0           0           0            0             0               0           0           0.00

üìà Overall Summary:
Total Tokens Consumed: 4713
Total Requests: 7
Total Errors: 3
Total Cost (USD): $2.85
Active Resources (with usage): 1 / 7
Overall Success Rate: 57.1%

üíæ Results exported to: azure-openai-metrics-20251014-103045.csv

üî• Resources with Activity:
ResourceName              TotalTokens TotalRequests SuccessRate ActualCostUSD
------------              ----------- ------------- ----------- -------------
azure-openai-eastus-prod 4713        7             57.1        2.85

‚úÖ Metrics collection completed!
```

### CSV Export Format
The script generates a timestamped CSV file with the following columns:
- ResourceName
- ResourceGroup  
- Location
- TotalTokens
- InputTokens
- OutputTokens
- TotalRequests
- SuccessfulCalls
- TotalErrors
- SuccessRate
- **ActualCostUSD**

## ‚ö° Performance Features

### **Parallel Processing**
- **Resource-Level Parallelization**: Multiple Azure OpenAI resources processed simultaneously
- **Metric-Level Parallelization**: All 6 metrics collected in parallel per resource using background jobs
- **Throttle Control**: Configurable concurrency limits to prevent API rate limiting
- **Performance Gain**: **~10x faster** than sequential processing

### **Execution Time Examples**
- **7 Resources (Sequential)**: ~2-3 minutes
- **7 Resources (Parallel)**: ~15-30 seconds ‚ö°
- **Benefits**: Scales efficiently with more resources

## üõ†Ô∏è Troubleshooting

### Common Issues

#### "No OpenAI resources found"
```powershell
# Verify you're in the correct subscription
az account show

# List all subscriptions
az account list --output table

# Set correct subscription
az account set --subscription "your-subscription-id"
```

#### "az command not found"
```powershell
# Install Azure CLI
winget install Microsoft.AzureCLI

# Restart PowerShell and try again
```

#### "Access denied" errors
- Ensure you have **Reader** role on the subscription or resource groups
- Verify **Monitoring Reader** role for Azure Monitor access
- Verify **Cost Management Reader** role for cost data access
- Check that Azure OpenAI resources exist and are accessible

#### Cost data showing as $0.00
- Cost data may have a 24-48 hour delay in Azure billing
- Verify you have Cost Management permissions
- Check if resources have been actively used and billed
- Extend time range: `-DaysBack 30` for more comprehensive cost data

#### No metrics data returned
- Azure Monitor metrics have a slight delay (usually 5-15 minutes)
- Extend the time range: `-DaysBack 30`
- Verify the resources have been actively used
- Check if resources are in different subscriptions

## üîí Security Considerations

- The script only **reads** metrics and cost data, no write operations
- Uses Azure CLI authentication (respects your current login)
- Cost data access requires appropriate Azure RBAC permissions
- No sensitive data is stored in the script
- CSV exports contain only aggregated metrics and costs, no request content
- All API calls use standard Azure authentication and authorization

## üìù Customization

### Modify Metrics Collection
To add or change metrics, edit the metrics collection section:

```powershell
# Add new metric (example: BlockedCalls)
$blockedData = az monitor metrics list --resource $resourceId --metric "BlockedCalls" --start-time $startTimeStr --end-time $endTimeStr --interval PT1H --aggregation Total --output json | ConvertFrom-Json
$blockedCalls = ($blockedData.value[0].timeseries[0].data | Measure-Object -Property total -Sum).Sum
```

### Change Time Intervals
Modify the `--interval` parameter:
- `PT1H` - Hourly aggregation
- `PT1M` - Minute aggregation  
- `PT1D` - Daily aggregation

### Filter Specific Resource Groups
Add resource group filtering to the query:
```powershell
$query = "Resources | where type == 'microsoft.cognitiveservices/accounts' and kind == 'OpenAI' and resourceGroup == 'your-rg-name' | where subscriptionId == '$SubscriptionId' | project name, resourceGroup, location, id"
```

## ü§ù Contributing

To enhance this script:
1. Test changes with multiple Azure OpenAI resources
2. Ensure error handling for edge cases
3. Maintain backward compatibility with parameters
4. Update documentation for new features

## üìÑ License

This script is provided as-is for Azure OpenAI monitoring purposes. Modify and distribute according to your organization's policies.

## üÜò Support

For issues:
1. Check the troubleshooting section above
2. Verify Azure CLI installation and authentication
3. Ensure proper Azure RBAC permissions
4. Test with a smaller time range first

## üìö Related Resources

- [Azure OpenAI Service Documentation](https://docs.microsoft.com/azure/cognitive-services/openai/)
- [Azure Monitor Metrics](https://docs.microsoft.com/azure/azure-monitor/platform/metrics-supported)
- [Azure CLI Documentation](https://docs.microsoft.com/cli/azure/)
- [Azure Resource Graph](https://docs.microsoft.com/azure/governance/resource-graph/)

---

**Last Updated**: October 2025  
**Version**: 1.0  
**Compatibility**: PowerShell 5.1+, Azure CLI 2.0+